{% extends "base/base.html" %}

{% block content %}
  <div class="container">
    <div class="row">
      <div class="col-md-8">
        <h2>Chat with Assistant for {{ trip_request.destination }}</h2>
        <p class="text-muted">Get personalized help with your {{ trip_request.duration }}-day trip (Budget: ${{ trip_request.budget }})</p>
      </div>
      <div class="col-md-4">
        <div class="card">
          <div class="card-body">
            <h6 class="card-title">Trip Details</h6>
            <p class="card-text small">
              <strong>Destination:</strong> {{ trip_request.destination }}<br>
              <strong>Duration:</strong> {{ trip_request.duration }} days<br>
              <strong>Travelers:</strong> {{ trip_request.number_of_travelers }}<br>
              <strong>Budget:</strong> ${{ trip_request.budget }}
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="chat-container mt-4">
      <div id="chat-history" class="chat-history">
        {% for message in messages %}
          <div class="chat-message {{ message.sender }}">
            <div class="message-content">
              <strong>{{ message.get_sender_display }}:</strong>
              <p>{{ message.content|linebreaksbr }}</p>
              {% if message.file_attachment %}
                <a href="{{ message.file_attachment.url }}" class="btn btn-sm btn-outline-primary">Download Attachment</a>
              {% endif %}
              <small class="text-muted">{{ message.timestamp|date:"M d, H:i" }}</small>
            </div>
          </div>
        {% empty %}
          <div class="chat-message bot">
            <div class="message-content">
              <strong>Assistant:</strong>
              <p>Hello! I'm here to help you with your trip to {{ trip_request.destination }}. I have all your trip details and can assist with planning, modifications, or any questions you might have. How can I help you today?</p>
            </div>
          </div>
        {% endfor %}
      </div>
      
      <form id="chat-form" method="post" enctype="multipart/form-data" class="chat-form">
        {% csrf_token %}
        <div class="input-group">
          <input type="text" name="message" id="message-input" class="form-control" placeholder="Type your message here..." required>
          <div class="input-group-append">
            <label for="file-input" class="btn btn-outline-secondary">
              <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" name="file_attachment" id="file-input" accept="*/*" style="display: none;">
            <button type="submit" class="btn btn-success" id="send-btn">
              <i class="fas fa-paper-plane"></i> Send
            </button>
          </div>
        </div>
      </form>
      
      <div id="loading" class="text-center" style="display: none;">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
        <p>Assistant is thinking...</p>
      </div>
    </div>
  </div>

  <style>
    .chat-container {
      max-width: 800px;
      margin: 0 auto;
    }
    
    .chat-history {
      height: 400px;
      overflow-y: auto;
      border: 1px solid #dee2e6;
      border-radius: 0.375rem;
      padding: 1rem;
      background-color: #f8f9fa;
      margin-bottom: 1rem;
    }
    
    .chat-message {
      margin-bottom: 1rem;
    }
    
    .chat-message.user .message-content {
      background-color: #007bff;
      color: white;
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-left: 20%;
    }
    
    .chat-message.bot .message-content {
      background-color: #e9ecef;
      color: #495057;
      padding: 0.75rem;
      border-radius: 0.375rem;
      margin-right: 20%;
    }
    
    .chat-form {
      position: sticky;
      bottom: 0;
      background-color: white;
      padding: 1rem 0;
    }
    
    #file-input::-webkit-file-upload-button {
      display: none;
    }
  </style>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const chatHistory = document.getElementById('chat-history');
        const messageInput = document.getElementById('message-input');
        const sendBtn = document.getElementById('send-btn');
        const loading = document.getElementById('loading');
        const fileInput = document.getElementById('file-input');
        
        // Auto-scroll to bottom
        function scrollToBottom() {
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // Initial scroll
        scrollToBottom();
        
        // Show selected file name
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                messageInput.placeholder = `File selected: ${this.files[0].name}. Type a message (optional) and send.`;
                messageInput.required = false;
            } else {
                messageInput.placeholder = 'Type your message here...';
                messageInput.required = true;
            }
        });
        
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            const file = fileInput.files[0];
            
            if (!message && !file) {
                alert('Please enter a message or select a file.');
                return;
            }
            
            // Show user message immediately
            if (message) {
                const userMessage = document.createElement('div');
                userMessage.className = 'chat-message user';
                userMessage.innerHTML = `
                    <div class="message-content">
                        <strong>You:</strong>
                        <p>${message}</p>
                        <small class="text-muted">Just now</small>
                    </div>
                `;
                chatHistory.appendChild(userMessage);
            }
            
            // Show loading
            loading.style.display = 'block';
            sendBtn.disabled = true;
            messageInput.disabled = true;
            
            scrollToBottom();
            
            // Send request
            const formData = new FormData(chatForm);
            
            fetch(window.location.href, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                // Hide loading
                loading.style.display = 'none';
                sendBtn.disabled = false;
                messageInput.disabled = false;
                
                // Add bot response
                const botMessage = document.createElement('div');
                botMessage.className = 'chat-message bot';
                botMessage.innerHTML = `
                    <div class="message-content">
                        <strong>Assistant:</strong>
                        <p>${data.response.replace(/\n/g, '<br>')}</p>
                        <small class="text-muted">Just now</small>
                    </div>
                `;
                chatHistory.appendChild(botMessage);
                
                // Clear form
                messageInput.value = '';
                fileInput.value = '';
                messageInput.placeholder = 'Type your message here...';
                messageInput.required = true;
                
                scrollToBottom();
                messageInput.focus();
            })
            .catch(error => {
                console.error('Error:', error);
                loading.style.display = 'none';
                sendBtn.disabled = false;
                messageInput.disabled = false;
                
                const errorMessage = document.createElement('div');
                errorMessage.className = 'chat-message bot';
                errorMessage.innerHTML = `
                    <div class="message-content">
                        <strong>Assistant:</strong>
                        <p>Sorry, I encountered an error. Please try again.</p>
                        <small class="text-muted">Just now</small>
                    </div>
                `;
                chatHistory.appendChild(errorMessage);
                scrollToBottom();
            });
        });
        
        // Focus on input
        messageInput.focus();
        
        // Enter key to send
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatForm.dispatchEvent(new Event('submit'));
            }
        });
    });
  </script>
{% endblock %}

