{% extends "base/base.html" %}
{% load static %}
{% load cost_dashboard_math %}

{% block title %}Cost Dashboard - TripAI{% endblock %}

{% block extra_css %}
<style>
    /* === PERFORMANCE-OPTIMIZED STYLES === */
    
    /* Force hardware acceleration for better performance */
    .cost-card, .stat-item, .recommendation-card, .chart-container {
        will-change: transform;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
    }
    
    .cost-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
        /* Simplified transition - only transform for performance */
        transition: transform 0.2s ease;
    }
    
    .cost-card:hover {
        transform: translateY(-2px) translateZ(0);
    }
    
    .usage-metric {
        background: rgba(255, 255, 255, 0.1);
        /* Removed backdrop-filter for performance */
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 5px;
        /* Removed text-shadow for performance */
    }
    
    .metric-label {
        font-size: 1rem;
        opacity: 0.9;
        font-weight: 500;
    }
    
    .progress-custom {
        height: 8px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin-top: 10px;
    }
    
    .progress-bar-custom {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        border-radius: 10px;
        transition: width 0.3s ease;
        /* Removed shimmer animation for performance */
    }
    
    /* Removed expensive shimmer animation */
    
    .recommendation-card {
        background: white;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 20px;
        transition: transform 0.2s ease;
    }
    
    .recommendation-card:hover {
        transform: translateY(-1px) translateZ(0);
    }
    
    .recommendation-low {
        border-left: 5px solid #28a745;
    }
    
    .recommendation-medium {
        border-left: 5px solid #ffc107;
    }
    
    .recommendation-high {
        border-left: 5px solid #fd7e14;
    }
    
    .recommendation-critical {
        border-left: 5px solid #dc3545;
        /* Simplified pulse animation */
        animation: pulse-warning 3s ease-in-out infinite;
    }
    
    @keyframes pulse-warning {
        0%, 100% { 
            opacity: 1;
            transform: translateZ(0);
        }
        50% { 
            opacity: 0.8;
            transform: translateZ(0);
        }
    }
    
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-item {
        background: rgba(255, 255, 255, 0.95);
        /* Removed backdrop-filter for performance */
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s ease;
    }
    
    .stat-item:hover {
        transform: translateY(-2px) translateZ(0);
    }
    
    .stat-icon {
        font-size: 2.5rem;
        margin-bottom: 10px;
        display: block;
    }
    
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        /* Fixed height to prevent layout shifts */
        min-height: 400px;
    }
    
    /* Optimized chart canvas sizing */
    #usageChart, #costChart {
        max-height: 300px !important;
        height: 300px !important;
    }
    
    .refresh-btn {
        position: fixed;
        bottom: 30px;
        right: 30px;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        transition: transform 0.2s ease;
        /* Force hardware acceleration */
        will-change: transform;
        transform: translateZ(0);
    }
    
    .refresh-btn:hover {
        transform: scale(1.05) translateZ(0);
        /* Removed rotation for performance */
    }
    
    /* Reduce animations on mobile for better performance */
    @media (max-width: 768px) {
        .cost-card:hover,
        .stat-item:hover,
        .recommendation-card:hover {
            transform: none;
        }
        
        .recommendation-critical {
            animation: none;
        }
        
        /* Smaller chart heights on mobile */
        #usageChart, #costChart {
            max-height: 250px !important;
            height: 250px !important;
        }
        
        .chart-container {
            min-height: 300px;
        }
    }
    
    /* Disable animations during scrolling for better performance */
    .scrolling .cost-card,
    .scrolling .stat-item,
    .scrolling .recommendation-card {
        transition: none;
    }
    
    .scrolling .recommendation-critical {
        animation-play-state: paused;
    }
    
    /* Performance optimizations */
    * {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }
    
    /* Reduce repaints */
    .container {
        contain: layout style;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- Dashboard Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="gradient-text mb-2">üí∞ API Cost Dashboard</h1>
                    <p class="text-muted">Monitor and optimize your API usage costs</p>
                </div>
                <div class="text-end">
                    <small class="text-muted">Last updated: <span id="last-updated">{{ "now"|date:"M d, Y H:i" }}</span></small>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Cost Overview -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="cost-card">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="mb-1">Today's API Spending</h3>
                        <div class="metric-value">${{ usage.total_cost|floatformat:2 }}</div>
                        <div class="progress-custom mt-3">
                            {% with daily_limit=5.00 %}
                                {% with percentage=usage.total_cost|div:daily_limit|mul:100 %}
                                    <div class="progress-bar-custom" 
                                         style="width: {{ percentage|floatformat:0 }}%"
                                         data-percentage="{{ percentage|floatformat:1 }}"></div>
                                {% endwith %}
                            {% endwith %}
                        </div>
                        <small class="mt-2 d-block">{{ usage.total_cost|div:5.00|mul:100|floatformat:1 }}% of $5.00 daily budget</small>
                    </div>
                    <div class="col-md-4 text-end">
                        <div class="metric-value text-success">
                            ${{ 5.00|sub:usage.total_cost|floatformat:2 }}
                        </div>
                        <div class="metric-label">Remaining Today</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Detailed Stats Grid -->
    <div class="stats-grid">
        <div class="stat-item">
            <span class="stat-icon">ü§ñ</span>
            <div class="metric-value text-primary">{{ usage.openai.calls|default:0 }}</div>
            <div class="metric-label text-muted">OpenAI Calls</div>
            <small class="text-success">${{ usage.openai.cost|floatformat:3|default:"0.000" }}</small>
        </div>
        
        <div class="stat-item">
            <span class="stat-icon">üó∫Ô∏è</span>
            <div class="metric-value text-info">{{ usage.google_maps.calls|default:0 }}</div>
            <div class="metric-label text-muted">Google Maps Calls</div>
            <small class="text-success">${{ usage.google_maps.cost|floatformat:3|default:"0.000" }}</small>
        </div>
        
        {% if usage.cache_hit_rate %}
        <div class="stat-item">
            <span class="stat-icon">‚ö°</span>
            <div class="metric-value text-warning">{{ usage.cache_hit_rate|floatformat:1 }}%</div>
            <div class="metric-label text-muted">Cache Hit Rate</div>
            <small class="text-muted">Cost Savings</small>
        </div>
        {% endif %}
        
        <div class="stat-item">
            <span class="stat-icon">üí°</span>
            <div class="metric-value text-success">{{ usage.total_cost|div:usage.daily_limit|mul:100|sub:100|absolute|floatformat:0 }}%</div>
            <div class="metric-label text-muted">Budget Efficiency</div>
            <small class="text-muted">Under Budget</small>
        </div>
    </div>
    
    <!-- Cost Optimization Recommendations -->
    <div class="row">
        <div class="col-12">
            <h3 class="mb-3">üìä Optimization Recommendations</h3>
            <div class="recommendation-card recommendation-{{ recommendations.level }}">
                <div class="d-flex align-items-start">
                    <div class="me-3" style="font-size: 2rem;">
                        {% if recommendations.level == 'low' %}üü¢
                        {% elif recommendations.level == 'medium' %}üü°
                        {% elif recommendations.level == 'high' %}üü†
                        {% else %}üî¥
                        {% endif %}
                    </div>
                    <div class="flex-grow-1">
                        <h5 class="mb-3">{{ recommendations.message }}</h5>
                        
                        {% if recommendations.suggestions %}
                        <div class="row">
                            {% for suggestion in recommendations.suggestions %}
                                <div class="col-md-6 mb-2">
                                    <div class="d-flex align-items-center">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>
                                        <span>{{ suggestion }}</span>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Interactive Charts -->
    <div class="row">
        <div class="col-md-8">
            <div class="chart-container">
                <h5 class="mb-3">üìà API Usage Trends</h5>
                <canvas id="usageChart" height="100"></canvas>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="chart-container">
                <h5 class="mb-3">ü•ß Cost Distribution</h5>
                <canvas id="costChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Real-time Controls -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">üîß Quick Actions</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <button class="btn btn-primary" onclick="refreshDashboard()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh Data
                        </button>
                        <button class="btn btn-warning" onclick="showCacheStats()">
                            <i class="fas fa-database me-2"></i>Cache Statistics
                        </button>
                        <button class="btn btn-info" onclick="exportReport()">
                            <i class="fas fa-download me-2"></i>Export Report
                        </button>
                        <a href="{% url 'home' %}" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Floating Refresh Button -->
<button class="btn btn-primary refresh-btn" onclick="refreshDashboard()" title="Refresh Dashboard">
    <i class="fas fa-sync-alt"></i>
</button>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Performance optimization: Disable animations during scroll
let scrollTimer = null;
let isScrolling = false;

function disableAnimationsDuringScroll() {
    if (!isScrolling) {
        document.body.classList.add('scrolling');
        isScrolling = true;
    }
    
    clearTimeout(scrollTimer);
    scrollTimer = setTimeout(function() {
        document.body.classList.remove('scrolling');
        isScrolling = false;
    }, 150);
}

// Add scroll listener for performance
window.addEventListener('scroll', disableAnimationsDuringScroll, { passive: true });

document.addEventListener('DOMContentLoaded', function() {
    // Initialize charts with real data
    initializeCharts();
    
    // Auto-refresh every 5 minutes (reduced frequency for performance)
    setInterval(function() {
        updateDashboardData();
    }, 5 * 60 * 1000);
    
    // Optimize page performance
    optimizePagePerformance();
});

function initializeCharts() {
    // Usage trend chart with real hourly data
    const hourlyData = {{ hourly_data_json|safe }};
    const usageCtx = document.getElementById('usageChart').getContext('2d');
    const usageChart = new Chart(usageCtx, {
        type: 'line',
        data: {
            labels: hourlyData.labels || ['6h ago', '5h ago', '4h ago', '3h ago', '2h ago', '1h ago', 'Now'],
            datasets: [{
                label: 'OpenAI Calls',
                data: hourlyData.openai || [0, 0, 0, 0, 0, 0, {{ usage.openai.calls|default:0 }}],
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#667eea',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }, {
                label: 'Google Maps Calls',
                data: hourlyData.google_maps || [0, 0, 0, 0, 0, 0, {{ usage.google_maps.calls|default:0 }}],
                borderColor: '#764ba2',
                backgroundColor: 'rgba(118, 75, 162, 0.1)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#764ba2',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'API Calls Over Time (Last 6 Hours)',
                    font: { size: 16, weight: 'bold' }
                },
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 20
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0,0,0,0.1)'
                    }
                }
            },
            elements: {
                point: {
                    hoverRadius: 8
                }
            }
        }
    });
    
    // Enhanced cost distribution chart
    const costCtx = document.getElementById('costChart').getContext('2d');
    const costChart = new Chart(costCtx, {
        type: 'doughnut',
        data: {
            labels: ['OpenAI Costs', 'Google Maps Costs', 'Remaining Budget'],
            datasets: [{
                data: [
                    {{ usage.openai.cost|floatformat:2|default:0 }},
                    {{ usage.google_maps.cost|floatformat:2|default:0 }},
                    {{ 5.00|sub:usage.total_cost|floatformat:2 }}
                ],
                backgroundColor: [
                    '#667eea',
                    '#764ba2',
                    '#e9ecef'
                ],
                borderWidth: 3,
                borderColor: '#fff',
                hoverBorderWidth: 5,
                hoverOffset: 10
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'Daily Cost Breakdown',
                    font: { size: 16, weight: 'bold' }
                },
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const percentage = ((value / {{ usage.daily_limit|floatformat:2 }}) * 100).toFixed(1);
                            return `${label}: $${value.toFixed(2)} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}

function updateDashboardData() {
    // Update timestamp
    document.getElementById('last-updated').textContent = new Date().toLocaleString();
    
    // You could fetch fresh data here via AJAX
    console.log('Dashboard data updated');
}

function refreshDashboard() {
    const refreshIcon = document.querySelector('.refresh-btn i');
    refreshIcon.style.animation = 'spin 1s linear infinite';
    
    setTimeout(() => {
        window.location.reload();
    }, 500);
}

function showCacheStats() {
    // Real cache statistics from backend data
    const hourlyData = {{ hourly_data_json|safe }};
    const totalHits = hourlyData ? hourlyData.openai.reduce((a, b) => a + b, 0) + hourlyData.google_maps.reduce((a, b) => a + b, 0) : 0;
    const hitRate = {{ usage.cache_hit_rate|floatformat:1 }};
    const missRate = (100 - hitRate).toFixed(1);
    const estimatedSavings = ({{ usage.total_cost|floatformat:2 }} * (hitRate / 100) * 0.5).toFixed(2); // Rough estimate
    
    alert(`Real-Time Cache Statistics:\n\n` +
          `üìä Total API Requests Today: ${totalHits}\n` +
          `‚úÖ Cache Hit Rate: ${hitRate}%\n` +
          `‚ùå Cache Miss Rate: ${missRate}%\n` +
          `üí∞ Estimated Cost Savings: $${estimatedSavings}\n\n` +
          `This data is updated in real-time from actual API usage.`);
}


function exportReport() {
    // Generate a simple report - you could implement this as a CSV download
    const reportData = {
        date: new Date().toISOString().split('T')[0],
        openaiCalls: {{ usage.openai.calls|default:0 }},
        openaiCost: {{ usage.openai.cost|floatformat:2|default:0 }},
        gmapsCalls: {{ usage.google_maps.calls|default:0 }},
        gmapsCost: {{ usage.google_maps.cost|floatformat:2|default:0 }},
        totalCost: {{ usage.total_cost|floatformat:2 }},
        budgetUsed: '{{ usage.total_cost|div:5.00|mul:100|floatformat:1 }}%'
    };
    
    const csvContent = "data:text/csv;charset=utf-8," + 
        "Date,OpenAI Calls,OpenAI Cost,Google Maps Calls,Google Maps Cost,Total Cost,Budget Used\n" +
        `${reportData.date},${reportData.openaiCalls},$${reportData.openaiCost},${reportData.gmapsCalls},$${reportData.gmapsCost},$${reportData.totalCost},${reportData.budgetUsed}`;
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", `api_cost_report_${reportData.date}.csv`);
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

// Add some visual feedback animations
function animateProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar-custom');
    progressBars.forEach(bar => {
        const width = bar.style.width;
        bar.style.width = '0%';
        setTimeout(() => {
            bar.style.width = width;
        }, 100);
    });
}

// Performance optimization function
function optimizePagePerformance() {
    // Reduce Chart.js animation duration for better performance
    Chart.defaults.animation.duration = 600;
    
    // Use RAF for smoother animations
    requestAnimationFrame(() => {
        animateProgressBars();
    });
    
    // Throttle scroll events for better performance
    let ticking = false;
    function optimizedScrollHandler() {
        if (!ticking) {
            requestAnimationFrame(() => {
                disableAnimationsDuringScroll();
                ticking = false;
            });
            ticking = true;
        }
    }
    
    // Replace scroll listener with optimized version
    window.removeEventListener('scroll', disableAnimationsDuringScroll);
    window.addEventListener('scroll', optimizedScrollHandler, { passive: true });
    
    // Preload critical resources
    const criticalImages = document.querySelectorAll('img[data-src]');
    criticalImages.forEach(img => {
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    img.src = img.dataset.src;
                    observer.unobserve(img);
                }
            });
        });
        observer.observe(img);
    });
}

// Optimize Chart.js performance
Chart.defaults.font.family = 'Inter, -apple-system, BlinkMacSystemFont, sans-serif';
Chart.defaults.responsive = true;
Chart.defaults.plugins.legend.labels.usePointStyle = true;

// Animate progress bars on load with RAF
document.addEventListener('DOMContentLoaded', function() {
    requestAnimationFrame(() => {
        setTimeout(animateProgressBars, 200);
    });
});

// Performance monitoring (optional)
if ('performance' in window) {
    window.addEventListener('load', () => {
        setTimeout(() => {
            const perfData = performance.getEntriesByType('navigation')[0];
            console.log(`Page load time: ${perfData.loadEventEnd - perfData.loadEventStart}ms`);
        }, 0);
    });
}
</script>
{% endblock %}
